# Repository Guidelines (AI Agents)

This document guides AI coding agents working in this repository. It consolidates the house rules in this repo and the detailed guidance from `CLAUDE.md`.

## Quick Start & Commands
- `npm run dev`: React Router dev server with HMR (http://localhost:5173)
- `npm run start`: Cloudflare Wrangler local dev (simulates Worker)
- `npm run build`: Production build (SSR output for Worker)
- `npm run preview`: Preview the production build locally
- `npm run typecheck`: Generate Worker types, route types, and run TypeScript project checks
- `npm run deploy`: Build and deploy via Wrangler. Pushes to `main` also deploy (see `.github/workflows/deploy.yml`).

## Architecture Overview
- **Framework**: React Router v7 with SSR (`app/entry.server.tsx`)
- **Runtime**: Cloudflare Workers (`workers/app.ts`)
- **Styling**: Tailwind CSS v4 (`@tailwindcss/vite`), app styles in `app/app.css` and `app/editor.css`
- **Editor**: BlockNote (`@blocknote/*`)
- **Forms/Validation**: React Hook Form + Zod
- **UI**: Radix UI primitives; generated shadcn components in `app/components/ui/`

## Project Structure
- `app/`: Main source
  - `routes/`: File-based routing; route config in `app/routes.ts`
  - `components/` + `components/ui/`: Reusable components; `components/ui/*` are generated (do not hand-edit)
  - `features/`: Feature modules (auth, notes, image, wines, etc.)
  - `hooks/`, `lib/`, `layout/`, `types/`, `constants/`
  - Styles: `app/app.css`, `app/editor.css`
- `workers/`: Cloudflare Worker entry (`workers/app.ts`)
- `public/`: Static assets
- `context/` and `issue/`: Specs and implementation notes to consult before changes
- Aliases: import with `~/*` (see `tsconfig.json`) and shadcn aliases in `components.json`

## Routing & Data
- Routes defined via `app/routes.ts` with layouts:
  - Base layout: `app/layout/base.tsx`
  - WithPost layout: `app/layout/withPost.tsx`
  - Wines layout: `app/layout/wines.tsx`
- Data fetching: use `app/lib/fetcher.ts` and route loaders/actions (React Router v7)
- Auth state: loaded globally in `app/root.tsx` loader; pass via `Outlet` context

## Coding Style & Linting
- Use Biome for formatting/linting
  - Indentation: tabs
  - Line width: 100
  - Quotes: double quotes for JavaScript/TypeScript
  - Auto-organize imports: enabled
  - Run locally: `npx biome check app --write` (or `npx @biomejs/biome`)
- Tailwind CSS for styling (utility-first). Keep class names readable and consistent.
- Prefer aliased imports (e.g., `~/lib/utils`, `~/hooks/...`).

## TypeScript Rules
- Avoid `any` and `unknown` where possible; model domain types.
- Do not use `class` unless absolutely necessary; prefer functions and plain objects.
- Explicitly type variables, function parameters, and return values.
- Keep the project strict; align with `tsconfig.json` settings.

## React Guidelines
- Minimize `useState`/`useEffect`; leverage loaders, actions, derived state, and controlled components.
- Keep components small and focused; lift state only when needed.
- Prefer server-side data loading with React Router loaders; pass data through route context.

## Testing Guidelines
- No dedicated test runner is configured.
- At minimum, run `npm run typecheck` and validate loaders/actions in `npm run dev`.
- If adding tests, use Vitest + React Testing Library under `app/**/__tests__/*.test.tsx` with descriptive names.

## Commit & Pull Request Guidelines
- Commits: short, imperative (often Japanese), concise; add scope when useful.
- PRs against `main` should include:
  - What/why summary, linked issues, screenshots/GIFs for UI, validation steps
  - Call out breaking changes and environment variables touched
- CI deploys `main`; open draft PRs early for collaboration.

## Security & Configuration
- Local env vars: `.dev.vars` (e.g., `API_BASE_URL`, `R2_BASE_URL`). Never commit secrets.
- Production/staging secrets: Cloudflare/GitHub Secrets. Worker config in `wrangler.toml`.
- Server entry: `workers/app.ts` uses SSR `createRequestHandler`.

## Prohibited Actions
- Do not modify files under `app/components/ui/` (generated by shadcn).

## Tooling: Serena Command (Claude Code)
- For code analysis and read-heavy tasks in Claude Code, prefer the `/serena` command.
- Reference: `.claude/commands/serena.md` (options, patterns, and advanced usage).

## Context to Review Before Changes
- REST API context: `context/PostNotel_API_Documentation.md`
- Frontend specification: `context/PostNotel_Frontend_Specification.md`

---
Notes:
- Keep changes minimal and aligned with the existing style.
- When in doubt about routes, check `app/routes.ts` and the layouts listed above.
